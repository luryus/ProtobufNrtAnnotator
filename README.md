# ProtobufNrtAnnotator

Automatically adds nullable reference type (NRT) annotations to C# code generated by Grpc.Tools, since the upstream protoc compiler does not yet support them.

> [!CAUTION]
> This project is mostly vibe-coded but fully human-reviewed. I wrote this partly to play with Google Antigravity.

## Usage

Add the package to your project alongside `Grpc.Tools` and `Google.Protobuf`:

```xml
<ItemGroup>
  <PackageReference Include="Google.Protobuf" Version="..." />
  <PackageReference Include="Grpc.Tools" Version="..." PrivateAssets="All" />

  <PackageReference Include="ProtobufNrtAnnotator" Version="0.2.0">
    <IncludeAssets>build</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
</ItemGroup>

<ItemGroup>
  <Protobuf Include="yourfile.proto" />
</ItemGroup>
```

The package automatically processes protobuf-generated C# files during build and adds appropriate nullability annotations.

## How It Works

ProtobufNrtAnnotator is an MSBuild task that runs after Grpc.Tools generates C# code from `.proto` files. It uses Roslyn to:

1. Parse the generated C# syntax tree
2. Analyze each property, field, and parameter using semantic information
3. Determine which reference types should be nullable based on protobuf semantics (e.g., message fields are nullable, but repeated fields and collections are not)
4. Rewrite the syntax tree with appropriate `?` annotations
5. Save the modified code back to the generated files

This ensures your generated protobuf code works seamlessly with C# nullable reference types enabled.

## Development

### Releasing a New Version

This project uses GitHub Actions to automatically build, test, and publish to NuGet.org. To release a new version:

1. **Bump the version** using Cake:
   ```bash
   dotnet cake --target=BumpVersion --target-version=0.2.0
   ```

   This will automatically update `Directory.Build.props`, `Directory.Packages.props`, and `README.md`.

3. **Commit and push** the version change:
   ```bash
   git commit -am "Bump version to 0.2.0"
   git push
   ```

4. **Create and push a git tag** matching the version:
   ```bash
   git tag v0.2.0
   git push origin v0.2.0
   ```

The GitHub Actions release workflow will automatically:
- Build the project
- Run all tests
- Pack the NuGet package
- Publish to NuGet.org using trusted publishing (OIDC authentication)
