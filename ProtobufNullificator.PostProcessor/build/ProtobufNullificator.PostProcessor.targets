<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <PropertyGroup>
    <!-- Select the best tool version based on the running MSBuild runtime -->
    <!-- Default to net6.0 (runs on .NET 6, 7, 8, 9+) -->
    <ProtobufNullificatorToolFramework>net6.0</ProtobufNullificatorToolFramework>
    <!-- Upgrade to net8.0 if running on .NET 8+ SDK -->
    <ProtobufNullificatorToolFramework Condition="'$(MSBuildRuntimeType)' == 'Core' and '$(BundledNETCoreAppTargetFrameworkVersion)' >= '8.0'">net8.0</ProtobufNullificatorToolFramework>

    <!-- Define the path to the PostProcessor tool based on the selected framework -->
    <ProtobufNullificatorPostProcessorPath Condition="'$(ProtobufNullificatorPostProcessorPath)' == ''">$(MSBuildThisFileDirectory)..\tools\$(ProtobufNullificatorToolFramework)\ProtobufNullificator.PostProcessor.dll</ProtobufNullificatorPostProcessorPath>
    
    <!-- Allow users to disable the task if needed -->
    <EnableProtobufNullificator Condition="'$(EnableProtobufNullificator)' == ''">true</EnableProtobufNullificator>
  </PropertyGroup>

  <!-- Define the target that runs the PostProcessor -->
  <Target Name="RunProtobufNullificator" 
          BeforeTargets="CoreCompile" 
          AfterTargets="Protobuf_Compile"
          Condition="'$(EnableProtobufNullificator)' == 'true'">
    
    <!-- Only run if we have files to process -->
    <ItemGroup>
      <ProtobufCsFiles Include="@(_Protobuf_CodeCompile)" />
      <CompileFiles Include="@(Compile)" />
    </ItemGroup>

    <Message Text="ProtobufNullificator: Processing files from _Protobuf_CodeCompile" Importance="normal" />
    <Message Text="ProtobufNullificator: Using tool from $(ProtobufNullificatorToolFramework)" Importance="normal" />
    <Message Text="ProtobufNullificator: Found @(ProtobufCsFiles->Count()) .cs files" Importance="normal" Condition="'@(ProtobufCsFiles)' != ''" />
    
    <!-- Execute the PostProcessor tool -->
    <Exec Command="dotnet &quot;$(ProtobufNullificatorPostProcessorPath)&quot; @(ProtobufCsFiles->'&quot;%(FullPath)&quot;', ' ')" 
          Condition="'@(ProtobufCsFiles)' != ''"
          ConsoleToMSBuild="true"
          IgnoreExitCode="false">
      <Output TaskParameter="ConsoleOutput" PropertyName="PostProcessorOutput" />
    </Exec>
    
    <Message Text="$(PostProcessorOutput)" Importance="normal" Condition="'$(PostProcessorOutput)' != ''" />
    
  </Target>

</Project>
